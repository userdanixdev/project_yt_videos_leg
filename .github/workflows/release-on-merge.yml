name: Build EXE and Release (only if VERSION changed)

on:
  pull_request:
    types: [closed]
    branches: [master]

permissions:
  contents: write
  pull-requests: read

jobs:
  release:
    # Só roda quando for merge de PR vindo da dev
    if: >
      github.event.pull_request.merged == true &&
      github.event.pull_request.head.ref == 'dev'
    runs-on: windows-latest

    steps:
      - name: Check if VERSION changed in this PR
        id: verchanged
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const { owner, repo } = context.repo;

            // Lista arquivos alterados no PR (paginado)
            let page = 1;
            let changed = false;

            while (true) {
              const res = await github.rest.pulls.listFiles({
                owner,
                repo,
                pull_number: pr.number,
                per_page: 100,
                page
              });

              if (!res.data.length) break;

              for (const f of res.data) {
                // Queremos VERSION na raiz (exatamente "VERSION")
                if (f.filename === "VERSION") {
                  changed = true;
                  break;
                }
              }
              if (changed) break;
              page++;
            }

            core.setOutput("changed", changed ? "true" : "false");
            if (!changed) {
              core.notice("VERSION não foi alterado neste PR. Pulando tag/build/release.");
            }

      - name: Checkout main (merged)
        if: steps.verchanged.outputs.changed == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read version
        if: steps.verchanged.outputs.changed == 'true'
        id: ver
        shell: pwsh
        run: |
          $v = (Get-Content VERSION -Raw).Trim()
          if (-not $v) { throw "VERSION file empty" }
          echo "version=$v" >> $env:GITHUB_OUTPUT
          echo "tag=v$($v)" >> $env:GITHUB_OUTPUT

      - name: Create git tag if missing
        if: steps.verchanged.outputs.changed == 'true'
        shell: pwsh
        run: |
          git fetch --tags
          $tag = "${{ steps.ver.outputs.tag }}"
          $exists = git tag -l $tag
          if ($exists) {
            Write-Host "Tag already exists: $tag"
          } else {
            git tag $tag
            git push origin $tag
          }

      - name: Set up Python
        if: steps.verchanged.outputs.changed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        if: steps.verchanged.outputs.changed == 'true'
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          if (Test-Path requeriments.txt) { pip install -r requeriments.txt }
          pip install pyinstaller

      - name: Build EXE (PyInstaller spec)
        if: steps.verchanged.outputs.changed == 'true'
        shell: pwsh
        run: |
          if (!(Test-Path yt_leg\gui.spec)) { throw "yt_leg/gui.spec not found." }
          Set-Location yt_leg
          pyinstaller --noconfirm --clean gui.spec

      - name: Pack artifact (zip dist/)
        if: steps.verchanged.outputs.changed == 'true'
        shell: pwsh
        run: |
          if (!(Test-Path yt_leg\dist)) { throw "yt_leg/dist not found. PyInstaller failed." }
          Compress-Archive -Path yt_leg\dist\* -DestinationPath "app-windows-${{ steps.ver.outputs.tag }}.zip"

      - name: Create GitHub Release + upload asset
        if: steps.verchanged.outputs.changed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ver.outputs.tag }}
          name: ${{ steps.ver.outputs.tag }}
          generate_release_notes: true
          files: app-windows-${{ steps.ver.outputs.tag }}.zip